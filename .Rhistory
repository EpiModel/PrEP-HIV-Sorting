prep.spec.yes <- 1 - prep.pi
prep.spec.add.casual <- runif(1,0,prep.pi) # prep.pi / 2
prep.spec.add.main <- runif(1,prep.spec.add.casual,prep.pi) # prep.pi - 0.01
prep.spec.add.once <- runif(1,0,prep.spec.add.casual) #0 + 0.01
prep.sens.base <- runif(1, 0.98, 1)
prep.sens.mult.unk <- 3
prep.sens.add.main <- runif(1, -0.04, -0.02)
prep.sens.add.casual <- prep.sens.add.main + runif(1, -0.03, -0.01)
prep.sens.add.once <- prep.sens.add.casual + runif(1, -0.04, -0.02)
prep.sens.mult.ego.prep <- runif(1, 0, 1)
prep.sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort2$prep.sens.mult.ego.prep <- ifelse(artnetSort2$prep.during.ego2 == 1, prep.sens.mult.ego.prep, 1)
artnetSort2$prep.sens.mult.ego.hiv <- ifelse(artnetSort2$hiv2 == 1, prep.sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort2$prep.spec[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.main
artnetSort2$prep.spec[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.casual
artnetSort2$prep.spec[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.once
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.main * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.casual * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.casual * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.once * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.once * prep.sens.mult.unk
artnetSort2$prep.q.sens <- log(artnetSort2$prep.sens/(1-artnetSort2$prep.sens)) - log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.sens[artnetSort2$prep.during.part2 == "Yes"] <- 0.01
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "No"] <- log(prep.spec.no/(1-prep.spec.no)) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Yes"] <- log(artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"]/(1-artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"])) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Unk"] <- log(prep.spec.unk/(1-prep.spec.unk)) + log(prep.pi/(1-prep.pi))
# P(Y*=y*|Y,X,R=0)
artnetSort2$prep.sens.xr <- (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)) / (artnetSort2$prep.star0 + (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)))
artnetSort2$prep.spec.xr <- (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)) / (artnetSort2$prep.star1 + (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)))
#### PrEP Imputations ------
# P(Y=1|X,R=0)
artnetSort2$prep.pred <- (artnetSort2$prep.star1 + artnetSort2$prep.spec.xr - 1) / (artnetSort2$prep.sens.xr + artnetSort2$prep.spec.xr - 1)
# prep: imputed
artnetSort2$prep.imp <- rbinom(nrow(artnetSort2),1,artnetSort2$prep.pred)
artnetSort3 <- artnetSort2 %>% select(alter_id, prep.imp)
artnetSort4 <- left_join(artnetSort1, artnetSort3, by = "alter_id")
#### Tables -----
# prop.table(table(artnetSort4$p_hiv.imp))
# prop.table(table(artnetSort4$hiv2, artnetSort4$p_hiv.imp, useNA = "ifany"),1)
artnetSort4$prep.ego[!artnetSort4$prep.during.ego2 == "Yes"] <- 0
artnetSort4$prep.ego[artnetSort4$prep.during.ego2 == "Yes"] <- 1
prop.table(table(artnetSort4$prep.imp))
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$p_hiv.imp[artnetSort4$hiv2 == 0]),1)
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$prep.imp[artnetSort4$hiv2 == 0]),1)
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
p_hiv2.pred.star <- inla.posterior.sample(n.imp, p_hiv2.inla)
# P(hiv2* = 1)
artnetSort1$p_hiv2.star1 <- exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)])/(1+exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)]))
## P(hiv2* = 0)
artnetSort1$p_hiv2.star0 <- 1 - artnetSort1$p_hiv2.star1
#### q parameters ----
pi <- median(artnetSort1$p_hiv2.star1)
spec.pos <- runif(1, 1-pi + 0.004, 1)
spec.neg <- runif(1, 1-pi, 1-pi + pi/2)
spec.unk <- runif(1, spec.neg, 1)
sens.base <- runif(1, 0.98, 1)
sens.mult.unk <- 5
sens.add.main <- runif(1, -0.05, -0.03)
sens.add.casual <-sens.add.main + runif(1, -0.03, -0.01)
sens.add.once <- sens.add.casual + runif(1, -0.045, -0.035)
sens.mult.part.prep <- runif(1, 0, 1)
sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort1$sens.mult.part.prep <- ifelse(artnetSort1$prep.during.part2 == "Yes", sens.mult.part.prep, 1)
artnetSort1$sens.mult.ego.hiv <- ifelse(artnetSort1$hiv2 == 1, sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Neg"] <- sens.base
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.main * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.casual * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.casual * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.once * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.once * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"]
artnetSort1$q.sens <- log(artnetSort1$sens/(1-artnetSort1$sens)) - log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Pos"] <- log(spec.pos/(1-spec.pos)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Neg"] <- log(spec.neg/(1-spec.neg)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Unk"] <- log(spec.unk/(1-spec.unk)) + log(pi/(1-pi))
artnetSort1$q.sens[artnetSort1$p_hiv == "Pos"] <- 0.01
# P(Y*=y*|Y,X,R=0)
artnetSort1$sens.xr <- (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)) / (artnetSort1$p_hiv2.star0 + (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)))
artnetSort1$spec.xr <- (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)) / (artnetSort1$p_hiv2.star1 + (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)))
#### HIV Imputations ------
# P(Y=1|X,R=0)
artnetSort1$p_hiv2.pred <- (artnetSort1$p_hiv2.star1 + artnetSort1$spec.xr - 1) / (artnetSort1$sens.xr + artnetSort1$spec.xr - 1)
# p_hiv: imputed
artnetSort1$p_hiv.imp <- rbinom(nrow(artnetSort1),1,artnetSort1$p_hiv2.pred)
prop.table(table(artnetSort1$p_hiv.imp))
prop.table(table(artnetSort1$hiv2, artnetSort1$p_hiv.imp, useNA = "ifany"),1)
prop.table(table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp),1)
table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp)
#### PrEP Sorting ------
## Data set
artnetSort2 <- artnetSort1 %>% filter(artnetSort1$p_hiv.imp == 0)
# prep: unk set to NA
artnetSort2$prep.part <- as.numeric(artnetSort2$prep.during.part2)
artnetSort2$prep.part = artnetSort2$prep.part - 1
artnetSort2$prep.part[artnetSort2$prep.part == 2] <- NA
# Imputation model
prep.inla <- inla(prep.part ~ p_race.cat + p_age.cat_imp + p_race.cat:p_age.cat_imp +
age.cat + race.cat + age.cat:race.cat +
city2 + f(AMIS_ID, model = "iid"),
data = artnetSort2, family = "binomial",
control.predictor = list(link = 1, compute = TRUE),
control.compute = list(config = TRUE))
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
prep.pred.star <- inla.posterior.sample(n.imp, prep.inla)
## P(prep* = 1)
artnetSort2$prep.star1 <- exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)])/(1+exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)]))
## P(prep* = 0)
artnetSort2$prep.star0 <- 1 - artnetSort2$prep.star1
#### q parameters ----
prep.pi <- median(artnetSort2$prep.star1)
prep.spec.no <- runif(1, 1 - prep.pi + 0.01, 1 - prep.pi + 0.03)
prep.spec.unk <- runif(1, prep.spec.no, prep.spec.no + 0.03)
prep.spec.yes <- 1 - prep.pi
prep.spec.add.casual <- runif(1,0,prep.pi) # prep.pi / 2
prep.spec.add.main <- runif(1,prep.spec.add.casual,prep.pi) # prep.pi - 0.01
prep.spec.add.once <- runif(1,0,prep.spec.add.casual) #0 + 0.01
prep.sens.base <- runif(1, 0.98, 1)
prep.sens.mult.unk <- 3
prep.sens.add.main <- runif(1, -0.04, -0.02)
prep.sens.add.casual <- prep.sens.add.main + runif(1, -0.03, -0.01)
prep.sens.add.once <- prep.sens.add.casual + runif(1, -0.04, -0.02)
prep.sens.mult.ego.prep <- runif(1, 0, 1)
prep.sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort2$prep.sens.mult.ego.prep <- ifelse(artnetSort2$prep.during.ego2 == 1, prep.sens.mult.ego.prep, 1)
artnetSort2$prep.sens.mult.ego.hiv <- ifelse(artnetSort2$hiv2 == 1, prep.sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort2$prep.spec[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.main
artnetSort2$prep.spec[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.casual
artnetSort2$prep.spec[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.once
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.main * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.casual * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.casual * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.once * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.once * prep.sens.mult.unk
artnetSort2$prep.q.sens <- log(artnetSort2$prep.sens/(1-artnetSort2$prep.sens)) - log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.sens[artnetSort2$prep.during.part2 == "Yes"] <- 0.01
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "No"] <- log(prep.spec.no/(1-prep.spec.no)) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Yes"] <- log(artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"]/(1-artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"])) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Unk"] <- log(prep.spec.unk/(1-prep.spec.unk)) + log(prep.pi/(1-prep.pi))
# P(Y*=y*|Y,X,R=0)
artnetSort2$prep.sens.xr <- (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)) / (artnetSort2$prep.star0 + (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)))
artnetSort2$prep.spec.xr <- (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)) / (artnetSort2$prep.star1 + (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)))
#### PrEP Imputations ------
# P(Y=1|X,R=0)
artnetSort2$prep.pred <- (artnetSort2$prep.star1 + artnetSort2$prep.spec.xr - 1) / (artnetSort2$prep.sens.xr + artnetSort2$prep.spec.xr - 1)
# prep: imputed
artnetSort2$prep.imp <- rbinom(nrow(artnetSort2),1,artnetSort2$prep.pred)
artnetSort3 <- artnetSort2 %>% select(alter_id, prep.imp)
artnetSort4 <- left_join(artnetSort1, artnetSort3, by = "alter_id")
#### Tables -----
# prop.table(table(artnetSort4$p_hiv.imp))
# prop.table(table(artnetSort4$hiv2, artnetSort4$p_hiv.imp, useNA = "ifany"),1)
artnetSort4$prep.ego[!artnetSort4$prep.during.ego2 == "Yes"] <- 0
artnetSort4$prep.ego[artnetSort4$prep.during.ego2 == "Yes"] <- 1
prop.table(table(artnetSort4$prep.imp))
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$p_hiv.imp[artnetSort4$hiv2 == 0]),1)
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$prep.imp[artnetSort4$hiv2 == 0]),1)
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
p_hiv2.pred.star <- inla.posterior.sample(n.imp, p_hiv2.inla)
# P(hiv2* = 1)
artnetSort1$p_hiv2.star1 <- exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)])/(1+exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)]))
## P(hiv2* = 0)
artnetSort1$p_hiv2.star0 <- 1 - artnetSort1$p_hiv2.star1
#### q parameters ----
pi <- median(artnetSort1$p_hiv2.star1)
spec.pos <- runif(1, 1-pi + 0.004, 1)
spec.neg <- runif(1, 1-pi, 1-pi + pi/2)
spec.unk <- runif(1, spec.neg, 1)
sens.base <- runif(1, 0.98, 1)
sens.mult.unk <- 5
sens.add.main <- runif(1, -0.05, -0.03)
sens.add.casual <-sens.add.main + runif(1, -0.03, -0.01)
sens.add.once <- sens.add.casual + runif(1, -0.045, -0.035)
sens.mult.part.prep <- runif(1, 0, 1)
sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort1$sens.mult.part.prep <- ifelse(artnetSort1$prep.during.part2 == "Yes", sens.mult.part.prep, 1)
artnetSort1$sens.mult.ego.hiv <- ifelse(artnetSort1$hiv2 == 1, sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Neg"] <- sens.base
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.main * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.casual * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.casual * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.once * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.once * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"]
artnetSort1$q.sens <- log(artnetSort1$sens/(1-artnetSort1$sens)) - log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Pos"] <- log(spec.pos/(1-spec.pos)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Neg"] <- log(spec.neg/(1-spec.neg)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Unk"] <- log(spec.unk/(1-spec.unk)) + log(pi/(1-pi))
artnetSort1$q.sens[artnetSort1$p_hiv == "Pos"] <- 0.01
# P(Y*=y*|Y,X,R=0)
artnetSort1$sens.xr <- (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)) / (artnetSort1$p_hiv2.star0 + (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)))
artnetSort1$spec.xr <- (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)) / (artnetSort1$p_hiv2.star1 + (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)))
#### HIV Imputations ------
# P(Y=1|X,R=0)
artnetSort1$p_hiv2.pred <- (artnetSort1$p_hiv2.star1 + artnetSort1$spec.xr - 1) / (artnetSort1$sens.xr + artnetSort1$spec.xr - 1)
# p_hiv: imputed
artnetSort1$p_hiv.imp <- rbinom(nrow(artnetSort1),1,artnetSort1$p_hiv2.pred)
prop.table(table(artnetSort1$p_hiv.imp))
prop.table(table(artnetSort1$hiv2, artnetSort1$p_hiv.imp, useNA = "ifany"),1)
prop.table(table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp),1)
table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp)
#### PrEP Sorting ------
## Data set
artnetSort2 <- artnetSort1 %>% filter(artnetSort1$p_hiv.imp == 0)
# prep: unk set to NA
artnetSort2$prep.part <- as.numeric(artnetSort2$prep.during.part2)
artnetSort2$prep.part = artnetSort2$prep.part - 1
artnetSort2$prep.part[artnetSort2$prep.part == 2] <- NA
# Imputation model
prep.inla <- inla(prep.part ~ p_race.cat + p_age.cat_imp + p_race.cat:p_age.cat_imp +
age.cat + race.cat + age.cat:race.cat +
city2 + f(AMIS_ID, model = "iid"),
data = artnetSort2, family = "binomial",
control.predictor = list(link = 1, compute = TRUE),
control.compute = list(config = TRUE))
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
prep.pred.star <- inla.posterior.sample(n.imp, prep.inla)
## P(prep* = 1)
artnetSort2$prep.star1 <- exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)])/(1+exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)]))
## P(prep* = 0)
artnetSort2$prep.star0 <- 1 - artnetSort2$prep.star1
#### q parameters ----
prep.pi <- median(artnetSort2$prep.star1)
prep.spec.no <- runif(1, 1 - prep.pi + 0.01, 1 - prep.pi + 0.03)
prep.spec.unk <- runif(1, prep.spec.no, prep.spec.no + 0.03)
prep.spec.yes <- 1 - prep.pi
prep.spec.add.casual <- runif(1,0,prep.pi) # prep.pi / 2
prep.spec.add.main <- runif(1,prep.spec.add.casual,prep.pi) # prep.pi - 0.01
prep.spec.add.once <- runif(1,0,prep.spec.add.casual) #0 + 0.01
prep.sens.base <- runif(1, 0.98, 1)
prep.sens.mult.unk <- 3
prep.sens.add.main <- runif(1, -0.04, -0.02)
prep.sens.add.casual <- prep.sens.add.main + runif(1, -0.03, -0.01)
prep.sens.add.once <- prep.sens.add.casual + runif(1, -0.04, -0.02)
prep.sens.mult.ego.prep <- runif(1, 0, 1)
prep.sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort2$prep.sens.mult.ego.prep <- ifelse(artnetSort2$prep.during.ego2 == 1, prep.sens.mult.ego.prep, 1)
artnetSort2$prep.sens.mult.ego.hiv <- ifelse(artnetSort2$hiv2 == 1, prep.sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort2$prep.spec[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.main
artnetSort2$prep.spec[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.casual
artnetSort2$prep.spec[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.once
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.main * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.casual * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.casual * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.once * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.once * prep.sens.mult.unk
artnetSort2$prep.q.sens <- log(artnetSort2$prep.sens/(1-artnetSort2$prep.sens)) - log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.sens[artnetSort2$prep.during.part2 == "Yes"] <- 0.01
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "No"] <- log(prep.spec.no/(1-prep.spec.no)) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Yes"] <- log(artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"]/(1-artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"])) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Unk"] <- log(prep.spec.unk/(1-prep.spec.unk)) + log(prep.pi/(1-prep.pi))
# P(Y*=y*|Y,X,R=0)
artnetSort2$prep.sens.xr <- (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)) / (artnetSort2$prep.star0 + (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)))
artnetSort2$prep.spec.xr <- (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)) / (artnetSort2$prep.star1 + (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)))
#### PrEP Imputations ------
# P(Y=1|X,R=0)
artnetSort2$prep.pred <- (artnetSort2$prep.star1 + artnetSort2$prep.spec.xr - 1) / (artnetSort2$prep.sens.xr + artnetSort2$prep.spec.xr - 1)
# prep: imputed
artnetSort2$prep.imp <- rbinom(nrow(artnetSort2),1,artnetSort2$prep.pred)
artnetSort3 <- artnetSort2 %>% select(alter_id, prep.imp)
artnetSort4 <- left_join(artnetSort1, artnetSort3, by = "alter_id")
#### Tables -----
# prop.table(table(artnetSort4$p_hiv.imp))
# prop.table(table(artnetSort4$hiv2, artnetSort4$p_hiv.imp, useNA = "ifany"),1)
artnetSort4$prep.ego[!artnetSort4$prep.during.ego2 == "Yes"] <- 0
artnetSort4$prep.ego[artnetSort4$prep.during.ego2 == "Yes"] <- 1
prop.table(table(artnetSort4$prep.imp))
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$p_hiv.imp[artnetSort4$hiv2 == 0]),1)
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$prep.imp[artnetSort4$hiv2 == 0]),1)
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
p_hiv2.pred.star <- inla.posterior.sample(n.imp, p_hiv2.inla)
# P(hiv2* = 1)
artnetSort1$p_hiv2.star1 <- exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)])/(1+exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)]))
## P(hiv2* = 0)
artnetSort1$p_hiv2.star0 <- 1 - artnetSort1$p_hiv2.star1
#### q parameters ----
pi <- median(artnetSort1$p_hiv2.star1)
spec.pos <- runif(1, 1-pi + 0.004, 1)
spec.neg <- runif(1, 1-pi, 1-pi + pi/2)
spec.unk <- runif(1, spec.neg, 1)
sens.base <- runif(1, 0.98, 1)
sens.mult.unk <- 5
sens.add.main <- runif(1, -0.05, -0.03)
sens.add.casual <-sens.add.main + runif(1, -0.03, -0.01)
sens.add.once <- sens.add.casual + runif(1, -0.045, -0.035)
sens.mult.part.prep <- runif(1, 0, 1)
sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort1$sens.mult.part.prep <- ifelse(artnetSort1$prep.during.part2 == "Yes", sens.mult.part.prep, 1)
artnetSort1$sens.mult.ego.hiv <- ifelse(artnetSort1$hiv2 == 1, sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Neg"] <- sens.base
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.main * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.casual * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.casual * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.once * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.once * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"]
artnetSort1$q.sens <- log(artnetSort1$sens/(1-artnetSort1$sens)) - log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Pos"] <- log(spec.pos/(1-spec.pos)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Neg"] <- log(spec.neg/(1-spec.neg)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Unk"] <- log(spec.unk/(1-spec.unk)) + log(pi/(1-pi))
artnetSort1$q.sens[artnetSort1$p_hiv == "Pos"] <- 0.01
# P(Y*=y*|Y,X,R=0)
artnetSort1$sens.xr <- (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)) / (artnetSort1$p_hiv2.star0 + (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)))
artnetSort1$spec.xr <- (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)) / (artnetSort1$p_hiv2.star1 + (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)))
#### HIV Imputations ------
# P(Y=1|X,R=0)
artnetSort1$p_hiv2.pred <- (artnetSort1$p_hiv2.star1 + artnetSort1$spec.xr - 1) / (artnetSort1$sens.xr + artnetSort1$spec.xr - 1)
# p_hiv: imputed
artnetSort1$p_hiv.imp <- rbinom(nrow(artnetSort1),1,artnetSort1$p_hiv2.pred)
prop.table(table(artnetSort1$p_hiv.imp))
prop.table(table(artnetSort1$hiv2, artnetSort1$p_hiv.imp, useNA = "ifany"),1)
prop.table(table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp),1)
table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp)
#### PrEP Sorting ------
## Data set
artnetSort2 <- artnetSort1 %>% filter(artnetSort1$p_hiv.imp == 0)
# prep: unk set to NA
artnetSort2$prep.part <- as.numeric(artnetSort2$prep.during.part2)
artnetSort2$prep.part = artnetSort2$prep.part - 1
artnetSort2$prep.part[artnetSort2$prep.part == 2] <- NA
# Imputation model
prep.inla <- inla(prep.part ~ p_race.cat + p_age.cat_imp + p_race.cat:p_age.cat_imp +
age.cat + race.cat + age.cat:race.cat +
city2 + f(AMIS_ID, model = "iid"),
data = artnetSort2, family = "binomial",
control.predictor = list(link = 1, compute = TRUE),
control.compute = list(config = TRUE))
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
prep.pred.star <- inla.posterior.sample(n.imp, prep.inla)
## P(prep* = 1)
artnetSort2$prep.star1 <- exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)])/(1+exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)]))
## P(prep* = 0)
artnetSort2$prep.star0 <- 1 - artnetSort2$prep.star1
#### q parameters ----
prep.pi <- median(artnetSort2$prep.star1)
prep.spec.no <- runif(1, 1 - prep.pi + 0.01, 1 - prep.pi + 0.03)
prep.spec.unk <- runif(1, prep.spec.no, prep.spec.no + 0.03)
prep.spec.yes <- 1 - prep.pi
prep.spec.add.casual <- runif(1,0,prep.pi) # prep.pi / 2
prep.spec.add.main <- runif(1,prep.spec.add.casual,prep.pi) # prep.pi - 0.01
prep.spec.add.once <- runif(1,0,prep.spec.add.casual) #0 + 0.01
prep.sens.base <- runif(1, 0.98, 1)
prep.sens.mult.unk <- 3
prep.sens.add.main <- runif(1, -0.04, -0.02)
prep.sens.add.casual <- prep.sens.add.main + runif(1, -0.03, -0.01)
prep.sens.add.once <- prep.sens.add.casual + runif(1, -0.04, -0.02)
prep.sens.mult.ego.prep <- runif(1, 0, 1)
prep.sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort2$prep.sens.mult.ego.prep <- ifelse(artnetSort2$prep.during.ego2 == 1, prep.sens.mult.ego.prep, 1)
artnetSort2$prep.sens.mult.ego.hiv <- ifelse(artnetSort2$hiv2 == 1, prep.sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort2$prep.spec[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.main
artnetSort2$prep.spec[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.casual
artnetSort2$prep.spec[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.once
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.main * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.casual * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.casual * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.once * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.once * prep.sens.mult.unk
artnetSort2$prep.q.sens <- log(artnetSort2$prep.sens/(1-artnetSort2$prep.sens)) - log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.sens[artnetSort2$prep.during.part2 == "Yes"] <- 0.01
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "No"] <- log(prep.spec.no/(1-prep.spec.no)) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Yes"] <- log(artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"]/(1-artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"])) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Unk"] <- log(prep.spec.unk/(1-prep.spec.unk)) + log(prep.pi/(1-prep.pi))
# P(Y*=y*|Y,X,R=0)
artnetSort2$prep.sens.xr <- (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)) / (artnetSort2$prep.star0 + (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)))
artnetSort2$prep.spec.xr <- (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)) / (artnetSort2$prep.star1 + (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)))
#### PrEP Imputations ------
# P(Y=1|X,R=0)
artnetSort2$prep.pred <- (artnetSort2$prep.star1 + artnetSort2$prep.spec.xr - 1) / (artnetSort2$prep.sens.xr + artnetSort2$prep.spec.xr - 1)
# prep: imputed
artnetSort2$prep.imp <- rbinom(nrow(artnetSort2),1,artnetSort2$prep.pred)
artnetSort3 <- artnetSort2 %>% select(alter_id, prep.imp)
artnetSort4 <- left_join(artnetSort1, artnetSort3, by = "alter_id")
#### Tables -----
# prop.table(table(artnetSort4$p_hiv.imp))
# prop.table(table(artnetSort4$hiv2, artnetSort4$p_hiv.imp, useNA = "ifany"),1)
artnetSort4$prep.ego[!artnetSort4$prep.during.ego2 == "Yes"] <- 0
artnetSort4$prep.ego[artnetSort4$prep.during.ego2 == "Yes"] <- 1
prop.table(table(artnetSort4$prep.imp))
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$p_hiv.imp[artnetSort4$hiv2 == 0]),1)
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$prep.imp[artnetSort4$hiv2 == 0]),1)
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
p_hiv2.pred.star <- inla.posterior.sample(n.imp, p_hiv2.inla)
# P(hiv2* = 1)
artnetSort1$p_hiv2.star1 <- exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)])/(1+exp(p_hiv2.pred.star[[1]]$latent[1:nrow(artnetSort1)]))
## P(hiv2* = 0)
artnetSort1$p_hiv2.star0 <- 1 - artnetSort1$p_hiv2.star1
#### q parameters ----
pi <- median(artnetSort1$p_hiv2.star1)
spec.pos <- runif(1, 1-pi + 0.004, 1)
spec.neg <- runif(1, 1-pi, 1-pi + pi/2)
spec.unk <- runif(1, spec.neg, 1)
sens.base <- runif(1, 0.98, 1)
sens.mult.unk <- 5
sens.add.main <- runif(1, -0.05, -0.03)
sens.add.casual <-sens.add.main + runif(1, -0.03, -0.01)
sens.add.once <- sens.add.casual + runif(1, -0.045, -0.035)
sens.mult.part.prep <- runif(1, 0, 1)
sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort1$sens.mult.part.prep <- ifelse(artnetSort1$prep.during.part2 == "Yes", sens.mult.part.prep, 1)
artnetSort1$sens.mult.ego.hiv <- ifelse(artnetSort1$hiv2 == 1, sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Neg"] <- sens.base
artnetSort1$sens[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.main * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Main" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.casual * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.casual * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Casual" & artnetSort1$p_hiv == "Unk"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] <- sens.base + sens.add.once * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"] * artnetSort1$sens.mult.ego.hiv[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Neg"]
artnetSort1$sens[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"] <- sens.base + sens.add.once * sens.mult.unk * artnetSort1$sens.mult.part.prep[artnetSort1$ptype == "Once" & artnetSort1$p_hiv == "Unk"]
artnetSort1$q.sens <- log(artnetSort1$sens/(1-artnetSort1$sens)) - log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Pos"] <- log(spec.pos/(1-spec.pos)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Neg"] <- log(spec.neg/(1-spec.neg)) + log(pi/(1-pi))
artnetSort1$q.spec[artnetSort1$p_hiv == "Unk"] <- log(spec.unk/(1-spec.unk)) + log(pi/(1-pi))
artnetSort1$q.sens[artnetSort1$p_hiv == "Pos"] <- 0.01
# P(Y*=y*|Y,X,R=0)
artnetSort1$sens.xr <- (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)) / (artnetSort1$p_hiv2.star0 + (artnetSort1$p_hiv2.star1 * exp(artnetSort1$q.sens)))
artnetSort1$spec.xr <- (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)) / (artnetSort1$p_hiv2.star1 + (artnetSort1$p_hiv2.star0 * exp(artnetSort1$q.spec)))
#### HIV Imputations ------
# P(Y=1|X,R=0)
artnetSort1$p_hiv2.pred <- (artnetSort1$p_hiv2.star1 + artnetSort1$spec.xr - 1) / (artnetSort1$sens.xr + artnetSort1$spec.xr - 1)
# p_hiv: imputed
artnetSort1$p_hiv.imp <- rbinom(nrow(artnetSort1),1,artnetSort1$p_hiv2.pred)
prop.table(table(artnetSort1$p_hiv.imp))
prop.table(table(artnetSort1$hiv2, artnetSort1$p_hiv.imp, useNA = "ifany"),1)
prop.table(table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp),1)
table(artnetSort1$p_hiv, artnetSort1$p_hiv.imp)
#### PrEP Sorting ------
## Data set
artnetSort2 <- artnetSort1 %>% filter(artnetSort1$p_hiv.imp == 0)
# prep: unk set to NA
artnetSort2$prep.part <- as.numeric(artnetSort2$prep.during.part2)
artnetSort2$prep.part = artnetSort2$prep.part - 1
artnetSort2$prep.part[artnetSort2$prep.part == 2] <- NA
# Imputation model
prep.inla <- inla(prep.part ~ p_race.cat + p_age.cat_imp + p_race.cat:p_age.cat_imp +
age.cat + race.cat + age.cat:race.cat +
city2 + f(AMIS_ID, model = "iid"),
data = artnetSort2, family = "binomial",
control.predictor = list(link = 1, compute = TRUE),
control.compute = list(config = TRUE))
#### Drawing predictive values from posterior distribution ----
n.imp <- 1
prep.pred.star <- inla.posterior.sample(n.imp, prep.inla)
## P(prep* = 1)
artnetSort2$prep.star1 <- exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)])/(1+exp(prep.pred.star[[1]]$latent[1:nrow(artnetSort2)]))
## P(prep* = 0)
artnetSort2$prep.star0 <- 1 - artnetSort2$prep.star1
#### q parameters ----
prep.pi <- median(artnetSort2$prep.star1)
prep.spec.no <- runif(1, 1 - prep.pi + 0.01, 1 - prep.pi + 0.03)
prep.spec.unk <- runif(1, prep.spec.no, prep.spec.no + 0.03)
prep.spec.yes <- 1 - prep.pi
prep.spec.add.casual <- runif(1,0,prep.pi) # prep.pi / 2
prep.spec.add.main <- runif(1,prep.spec.add.casual,prep.pi) # prep.pi - 0.01
prep.spec.add.once <- runif(1,0,prep.spec.add.casual) #0 + 0.01
prep.sens.base <- runif(1, 0.98, 1)
prep.sens.mult.unk <- 3
prep.sens.add.main <- runif(1, -0.04, -0.02)
prep.sens.add.casual <- prep.sens.add.main + runif(1, -0.03, -0.01)
prep.sens.add.once <- prep.sens.add.casual + runif(1, -0.04, -0.02)
prep.sens.mult.ego.prep <- runif(1, 0, 1)
prep.sens.mult.ego.hiv <- runif(1, 0, 1)
artnetSort2$prep.sens.mult.ego.prep <- ifelse(artnetSort2$prep.during.ego2 == 1, prep.sens.mult.ego.prep, 1)
artnetSort2$prep.sens.mult.ego.hiv <- ifelse(artnetSort2$hiv2 == 1, prep.sens.mult.ego.hiv, 1)
# calculating target sens and spec
artnetSort2$prep.spec[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.main
artnetSort2$prep.spec[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.casual
artnetSort2$prep.spec[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Yes"] <- prep.spec.yes + prep.spec.add.once
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base
artnetSort2$prep.sens[artnetSort2$ptype == "Main" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.main * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.casual * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Casual" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.casual * prep.sens.mult.unk
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] <- prep.sens.base + prep.sens.add.once * artnetSort2$prep.sens.mult.ego.prep[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"] * artnetSort2$prep.sens.mult.ego.hiv[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "No"]
artnetSort2$prep.sens[artnetSort2$ptype == "Once" & artnetSort2$prep.during.part2 == "Unk"] <- prep.sens.base + prep.sens.add.once * prep.sens.mult.unk
artnetSort2$prep.q.sens <- log(artnetSort2$prep.sens/(1-artnetSort2$prep.sens)) - log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.sens[artnetSort2$prep.during.part2 == "Yes"] <- 0.01
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "No"] <- log(prep.spec.no/(1-prep.spec.no)) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Yes"] <- log(artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"]/(1-artnetSort2$prep.spec[artnetSort2$prep.during.part2 == "Yes"])) + log(prep.pi/(1-prep.pi))
artnetSort2$prep.q.spec[artnetSort2$prep.during.part2 == "Unk"] <- log(prep.spec.unk/(1-prep.spec.unk)) + log(prep.pi/(1-prep.pi))
# P(Y*=y*|Y,X,R=0)
artnetSort2$prep.sens.xr <- (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)) / (artnetSort2$prep.star0 + (artnetSort2$prep.star1 * exp(artnetSort2$prep.q.sens)))
artnetSort2$prep.spec.xr <- (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)) / (artnetSort2$prep.star1 + (artnetSort2$prep.star0 * exp(artnetSort2$prep.q.spec)))
#### PrEP Imputations ------
# P(Y=1|X,R=0)
artnetSort2$prep.pred <- (artnetSort2$prep.star1 + artnetSort2$prep.spec.xr - 1) / (artnetSort2$prep.sens.xr + artnetSort2$prep.spec.xr - 1)
# prep: imputed
artnetSort2$prep.imp <- rbinom(nrow(artnetSort2),1,artnetSort2$prep.pred)
artnetSort3 <- artnetSort2 %>% select(alter_id, prep.imp)
artnetSort4 <- left_join(artnetSort1, artnetSort3, by = "alter_id")
#### Tables -----
# prop.table(table(artnetSort4$p_hiv.imp))
# prop.table(table(artnetSort4$hiv2, artnetSort4$p_hiv.imp, useNA = "ifany"),1)
artnetSort4$prep.ego[!artnetSort4$prep.during.ego2 == "Yes"] <- 0
artnetSort4$prep.ego[artnetSort4$prep.during.ego2 == "Yes"] <- 1
prop.table(table(artnetSort4$prep.imp))
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$p_hiv.imp[artnetSort4$hiv2 == 0]),1)
prop.table(table(artnetSort4$prep.ego[artnetSort4$hiv2 == 0], artnetSort4$prep.imp[artnetSort4$hiv2 == 0]),1)
library("ARTnetData")
library("tidyverse")
